name: Release Helm Charts

on:
  push:
    branches:
      - pr-on-release

jobs:
  # release:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0
  #         submodules: true

  #     - name: Configure Git
  #       run: |
  #         git config user.name "$GITHUB_ACTOR"
  #         git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

  #     - name: Install Helm
  #       uses: azure/setup-helm@v3
  #       with:
  #         version: v3.9.0

  #     - name: Add Helm repos
  #       run: |
  #         helm repo add radar https://radar-base.github.io/radar-helm-charts
  #         helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

  #     - name: Run chart-releaser
  #       uses: helm/chart-releaser-action@v1.4.0
  #       with:
  #         config: .github/cr.yaml
  #         charts_dir: charts
  #       env:
  #         CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  #     - name: Run chart-releaser -- external dependencies
  #       uses: helm/chart-releaser-action@v1.4.0
  #       with:
  #         config: .github/cr.yaml
  #         charts_dir: external
  #       env:
  #         CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  pr:
    # needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          repository: RADAR-base/RADAR-Kubernetes
          path: RADAR-Kubernetes
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}
          ref: 'dev'

      - name: Install yq
        run: |
          OS="$(uname | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')"
          YQ_VERSION=$(curl -Ls "https://github.com/mikefarah/yq/releases" | \grep 'href="/mikefarah/yq/releases/tag/v[0-9]*.[0-9]*.[0-9]*\"' | sed -E 's/.*\/mikefarah\/yq\/releases\/tag\/(v[0-9\.]+)".*/\1/g' | head -1)
          curl -fsSL -o yq "https://github.com/mikefarah/yq/releases/download/$YQ_VERSION/yq_${OS}_${ARCH}"
          sudo install -o root -g root -m 0755 yq /usr/local/bin/yq
          yq --version

      - name: Update chart versions
        run: |
          find . -name Chart.yaml -exec yq '{.name: {"_chart_version": .version}}' {} >> new-base.yaml \;
          cat new-base.yaml
          cd RADAR-Kubernetes
          git checkout -b charts-update
          git pull origin charts-update --ff-only || echo "Remote branch doesn't exist"
          yq -i '. *? load("../new-base.yaml")' etc/base.yaml
          cat etc/base.yaml

      - name: Commit changes
        env:
            GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          cd RADAR-Kubernetes
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git diff
          git commit -am "Updated helm charts to latest version" || echo "Nothing to commit, , working tree clean"
          git push origin charts-update

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd RADAR-Kubernetes
          gh pr create -B dev -H charts-update --title 'Updated helm charts to latest version' --body 'Created by Github action'
