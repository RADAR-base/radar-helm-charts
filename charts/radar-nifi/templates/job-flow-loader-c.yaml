{{- if .Values.flowLoader.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "common.names.fullname" . }}-flow-loader
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
spec:
  backoffLimit: 6
  template:
    metadata:
      labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      containers:
        - name: load-versioned-flow-snapshot
          image: curlimages/curl:8.10.1
          imagePullPolicy: IfNotPresent
          env:
            - name: NIFI_BASE_URL
              value: {{ .Values.flowLoader.nifiBaseUrl | quote }}
            - name: INSECURE
              value: {{ ternary "--insecure" "" .Values.flowLoader.insecureSkipTlsVerify | quote }}
            - name: TARGET_PG
              value: {{ .Values.flowLoader.targetProcessGroupId | default "root" | quote }}
            - name: WAIT_SECONDS
              value: {{ .Values.flowLoader.waitSeconds | default 300 | quote }}
            - name: EXPECTED_NAME
              value: {{ .Values.flowLoader.expectedName | default "" | quote }}
            - name: GROUP_NAME
              value: {{ default .Values.flowLoader.expectedName .Values.flowLoader.groupName | default "" | quote }}
            - name: POSITION_X
              value: {{ (index .Values.flowLoader "positionX") | default 0 | quote }}
            - name: POSITION_Y
              value: {{ (index .Values.flowLoader "positionY") | default 0 | quote }}
            - name: DISCONNECTED_ACK
              value: {{ .Values.flowLoader.disconnectedNodeAcknowledged | default true | quote }}
            - name: CLIENT_ID
              value: {{ .Values.flowLoader.clientId | default "" | quote }}
            - name: B64_SNAPSHOT
              value: {{ .Values.flowLoader.base64Snapshot | default "" | quote }}
            {{- if or .Values.flowLoader.configMap.data .Values.flowLoader.configMap.name }}
            - name: SNAPSHOT_FILE
              value: "/snapshot/{{ default "flow-snapshot.json" .Values.flowLoader.configMap.key }}"
            {{- end }}
          {{- if and .Values.flowLoader.auth .Values.flowLoader.auth.singleUser.enabled }}
            - name: NIFI_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.flowLoader.auth.singleUser.secretName }}
                  key: {{ .Values.flowLoader.auth.singleUser.usernameKey }}
            - name: NIFI_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.flowLoader.auth.singleUser.secretName }}
                  key: {{ .Values.flowLoader.auth.singleUser.passwordKey }}
          {{- end }}
          {{- if .Values.flowLoader.configMap.data }}
          volumeMounts:
            - name: flow-snapshot
              mountPath: /snapshot
              readOnly: true
          {{- end }}
          command: ["/bin/sh","-c"]
          args:
            - |
              set -euo pipefail

              FLOW_FILE=""
              # Prefer ConfigMap-mounted file if provided
              if [ -n "${SNAPSHOT_FILE:-}" ] && [ -s "${SNAPSHOT_FILE}" ]; then
                echo "Using snapshot from mounted ConfigMap file: ${SNAPSHOT_FILE}"
                FLOW_FILE="${SNAPSHOT_FILE}"
              else
                if [ -n "${B64_SNAPSHOT:-}" ]; then
                  echo "Decoding VersionedFlowSnapshot payload from base64 env into /tmp/flow-snapshot.json..."
                  echo "$B64_SNAPSHOT" | base64 -d > /tmp/flow-snapshot.json
                  FLOW_FILE="/tmp/flow-snapshot.json"
                else
                  echo "No snapshot provided. Supply flowLoader.base64Snapshot or mount via flowLoader.configMap.data. Exiting."
                  exit 0
                fi
              fi

              token=""
              if [ -n "${NIFI_USERNAME:-}" ] && [ -n "${NIFI_PASSWORD:-}" ]; then
                echo "Obtaining NiFi access token..."
                token=$(curl -sS ${INSECURE} -X POST \
                  -H 'Content-Type: application/x-www-form-urlencoded' \
                  --data-urlencode "username=${NIFI_USERNAME}" \
                  --data-urlencode "password=${NIFI_PASSWORD}" \
                  "${NIFI_BASE_URL}/nifi-api/access/token")
              fi

              echo "Waiting for NiFi API to become ready..."
              end=$(( $(date +%s) + ${WAIT_SECONDS} ))
              until curl -sS ${INSECURE} -H "Authorization: Bearer ${token}" "${NIFI_BASE_URL}/nifi-api/flow/status" >/dev/null; do
                if [ $(date +%s) -ge $end ]; then
                  echo "Timed out waiting for NiFi after ${WAIT_SECONDS}s" >&2
                  exit 1
                fi
                sleep 5
              done

              if [ "${TARGET_PG}" = "root" ]; then
                echo "Resolving root process group id..."
                TARGET_PG=$(curl -sS ${INSECURE} -H "Authorization: Bearer ${token}" "${NIFI_BASE_URL}/nifi-api/process-groups/root" \
                  | sed -n 's/.*"id":"\([a-f0-9-]\+\)".*/\1/p' | head -n1)
              fi
              echo "Target PG: ${TARGET_PG}"

              # Optional idempotency check at the API level by name
              if [ -n "${EXPECTED_NAME}" ]; then
                echo "Checking if a child Process Group named '${EXPECTED_NAME}' already exists under PG ${TARGET_PG}..."
                if curl -sS ${INSECURE} -H "Authorization: Bearer ${token}" \
                    "${NIFI_BASE_URL}/nifi-api/flow/process-groups/${TARGET_PG}" \
                    | grep -F '"name":"'"${EXPECTED_NAME}"'"' >/dev/null; then
                  echo "Child PG '${EXPECTED_NAME}' already exists. Skipping import."
                  exit 0
                fi
              fi

              echo "Importing flow via multipart upload to NiFi..."
              # Use the same endpoint and form-data format as the NiFi UI
              # POST /nifi-api/process-groups/{pgId}/process-groups/upload (multipart/form-data)
              filename="${GROUP_NAME:-flow}.json"
              # Perform request, capture HTTP status and response body
              echo curl
              http_code=$(curl -sS ${INSECURE} -X POST \
                -H "Authorization: Bearer ${token}" \
                -F groupName="${GROUP_NAME}" \
                -F positionX="${POSITION_X}" \
                -F positionY="${POSITION_Y}" \
                -F disconnectedNodeAcknowledged="${DISCONNECTED_ACK}" \
                -F file=@"${FLOW_FILE}"\;type=application/json\;filename="${filename}" \
                -w "%{http_code}" \
                -o /tmp/import-response.json \
                "${NIFI_BASE_URL}/nifi-api/process-groups/${TARGET_PG}/process-groups/upload")

              echo "NiFi upload HTTP status: ${http_code}"
              if [ "${http_code}" != "201" ]; then
                echo "Flow upload failed (expected 201). Response body:" >&2
                cat /tmp/import-response.json >&2 || true
                exit 1
              fi

              echo "Flow upload succeeded (201 Created)."
              exit 0
      {{- if .Values.flowLoader.configMap.data }}
      volumes:
        - name: flow-snapshot
          configMap:
            name: {{ include "common.names.fullname" . }}-properties
      {{- end }}
{{- end }}
